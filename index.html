<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>模擬訂房(四階段動態重測)+T0基本資料(台灣版)</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial;padding:20px;line-height:1.6;background:#f5f5f5;max-width:1400px;margin:0 auto}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:12px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #111827;background:#111827;color:#fff;cursor:pointer;font-size:14px;transition:all 0.2s}
    .btn:hover{background:#374151}
    .btn.secondary{background:#fff;color:#111827}
    .btn.secondary:hover{background:#f3f4f6}
    .muted{color:#6b7280;font-size:14px}
    .hidden{display:none}
    .step-title{font-weight:700;font-size:18px;margin-bottom:8px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #e5e7eb;border-radius:999px;font-size:12px;background:#fff}
    .ok{color:#10b981;font-weight:700}
    select,input[type="text"]{padding:8px;border:1px solid #e5e7eb;border-radius:8px;min-width:220px}
    .w-full{min-width:320px;width:320px}

    /* 7點量表 */
    .likert{display:grid;grid-template-columns:repeat(7,56px);gap:8px;align-items:flex-start;margin:6px 0;}
    .likert .cell{display:flex;flex-direction:column;align-items:center;font-size:13px;min-height:60px}
    .likert input[type="radio"]{margin:0 0 4px 0;transform:scale(1.1);cursor:pointer}
    .likert .cell span:last-child{display:block;min-height:32px;text-align:center;line-height:1.2;margin-top:2px}
    .qline{display:flex;align-items:center;gap:8px;margin-top:12px}
    .hint{color:#6b7280;font-size:13px;white-space:nowrap}

    /* 飯店資訊卡片 - 固定顯示在所有階段 */
    .hotel-info-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:20px}
    
    /* 圖片輪播區 */
    .carousel-container{position:relative;width:100%;height:500px;overflow:hidden;background:#000}
    .carousel-slides{display:flex;transition:transform 0.4s ease-in-out;height:100%}
    .carousel-slide{min-width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    .carousel-slide img{width:100%;height:100%;object-fit:contain;background:#f5f5f5}
    .carousel-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.6);color:#fff;border:none;padding:12px 16px;cursor:pointer;font-size:20px;z-index:10;transition:all 0.2s;border-radius:4px}
    .carousel-btn:hover{background:rgba(0,0,0,0.8)}
    .carousel-btn.prev{left:10px}
    .carousel-btn.next{right:10px}
    
    /* 縮圖導航 */
    .thumbs-nav{display:flex;gap:8px;padding:12px;background:#fafafa;overflow-x:auto;justify-content:center}
    .thumb-item{min-width:100px;width:100px;height:70px;cursor:pointer;border:3px solid transparent;border-radius:8px;overflow:hidden;transition:all 0.2s;background:#fff}
    .thumb-item:hover{transform:scale(1.05);box-shadow:0 2px 8px rgba(0,0,0,0.15)}
    .thumb-item.active{border-color:#059669;box-shadow:0 2px 12px rgba(5,150,105,0.3)}
    .thumb-item img{width:100%;height:100%;object-fit:cover}
    
    /* 飯店詳細資訊 */
    .hotel-details{padding:20px}
    .hotel-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;flex-wrap:wrap;gap:12px}
    .hotel-title{font-size:22px;font-weight:800;color:#111827;margin-bottom:4px}
    .hotel-subtitle{color:#6b7280;font-size:15px}
    .price-section{text-align:right}
    .price-label{font-size:15px;color:#6b7280;font-weight:500}
    .price-big{font-size:32px;font-weight:800;color:#059669}
    .price-original{font-size:16px;color:#9ca3af;text-decoration:line-through}
    
    .hotel-rating{display:flex;align-items:center;gap:8px;margin:12px 0}
    .stars{color:#f59e0b;font-size:18px}
    .rating-text{color:#6b7280;font-size:14px}
    
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin:16px 0}
    .badge{border:1px solid #86efac;border-radius:999px;padding:6px 12px;font-size:13px;background:#dcfce7;color:#059669}
    .badge.highlight{background:#bbf7d0;border-color:#4ade80;font-weight:600}
    
    .info-row{display:flex;align-items:center;gap:6px;margin:8px 0;color:#374151;font-size:14px}
    .info-row .icon{font-size:16px}
    
    /* 問題區域 */
    .questions-section{background:#f9fafb;padding:20px;border-radius:12px;border:1px solid #e5e7eb}
    .question-card{background:#fff;padding:16px;border-radius:8px;margin:12px 0;border:1px solid #e5e7eb}

    /* T4 選項卡片樣式 */
    .slider-option{flex:1;text-align:center;padding:12px;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all 0.2s;background:#fff}
    .slider-option:hover{border-color:#059669;background:#f0fdf4}
    .slider-option input[type="radio"]{display:none}

    @media (max-width: 768px){
      .carousel-container{height:350px}
      .hotel-header{flex-direction:column}
      .price-section{text-align:left}
      .thumb-item{min-width:80px;width:80px;height:56px}
    }
  </style>
</head>
<body>

<div class="topbar">
  <h1 style="margin:0">模擬訂房(四階段動態重測)</h1>
  <button class="btn hidden" id="btn_export">📥 匯出資料(CSV)</button>
</div>
<p class="muted">請依序完成:<b>T0基本資料 → T1 → T2 → T3 → T4</b>。每一步只有 1—3 題,完成後按下一步。</p>

<hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0"/>

<!-- T0 基本資料 -->
<div id="T0" class="card hidden">
  <div class="step-title">T0 基本資料 <span class="pill">第零步</span></div>
  
  <p class="muted">以下資料僅做學術研究,去識別化保存。</p>

  <div class="row">
    <div>
      <div>1) 性別</div>
      <select id="t0_gender">
        <option value="">請選擇</option>
        <option value="male">男性</option>
        <option value="female">女性</option>
        <option value="nonbinary">非二元性別</option>
      </select>
    </div>

    <div>
      <div>2) 年齡區間</div>
      <select id="t0_age">
        <option value="">請選擇</option>
        <option value="18-24">18—24 歲</option>
        <option value="25-34">25—34 歲</option>
        <option value="35-44">35—44 歲</option>
        <option value="45-54">45—54 歲</option>
        <option value="55+">55 歲以上</option>
      </select>
    </div>

    <div>
      <div>3) 職業</div>
      <select id="t0_job" class="w-full">
        <option value="">請選擇</option>
        <option>學生</option><option>上班族</option><option>自由業</option><option>退休</option><option>其他</option>
      </select>
    </div>

    <div>
      <div>4) 年收入</div>
      <select id="t0_income">
        <option value="">請選擇</option>
        <option value="<50">低於 50 萬</option>
        <option value="50-100">50—100 萬</option>
        <option value="100+">100 萬以上</option>
      </select>
    </div>

    <div>
      <div>5) 教育程度</div>
      <select id="t0_edu">
        <option value="">請選擇</option>
        <option value="high">高中/高職</option>
        <option value="college">大學/大專</option>
        <option value="grad">研究所以上</option>
      </select>
    </div>
  </div>

  <div style="margin-top:12px">
    <button class="btn" id="t0_next">開始實驗(進入 T1)</button>
  </div>
</div>

<!-- T1 -->
<div id="T1" class="card hidden">
  <div class="step-title">T1 初見價格 <span class="pill">第一步</span></div>
  
  <div class="questions-section">
    <p style="margin-top:0"><b>【高級雙人房】</b> 今日價格：<b>NT$ 3,241</b> 元</p>

    <div class="question-card">
      <div class="qline"><b>1) 你想要購買的程度：</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t1_intent_desire" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">完全不想</span></label>
        <label class="cell"><input type="radio" name="t1_intent_desire" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t1_intent_desire" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t1_intent_desire" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="t1_intent_desire" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t1_intent_desire" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t1_intent_desire" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">非常想買</span></label>
      </div>
    </div>

    <div class="question-card">
      <div class="qline"><b>2) 假設現在就要決定，你會購買這間房間嗎？</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t1_intent_action" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">絕對不會</span></label>
        <label class="cell"><input type="radio" name="t1_intent_action" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t1_intent_action" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t1_intent_action" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="t1_intent_action" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t1_intent_action" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t1_intent_action" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">一定會</span></label>
      </div>
    </div>

    <div class="question-card" style="background:#fff9e6;border:1px solid #fcd34d">
      <div class="qline"><b>⚠️ 注意力檢核：請選擇「3」</b></div>
      <div class="muted" style="margin-bottom:8px">請仔細選擇正確的數字</div>
      <div class="likert">
        <label class="cell"><input type="radio" name="attention_check" value="1"><span>1</span></label>
        <label class="cell"><input type="radio" name="attention_check" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="attention_check" value="3"><span>3</span><span style="font-size:11px;margin-top:2px;color:#dc2626;font-weight:600">✓</span></label>
        <label class="cell"><input type="radio" name="attention_check" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="attention_check" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="attention_check" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="attention_check" value="7"><span>7</span></label>
      </div>
    </div>

    <button class="btn" id="t1_next" style="margin-top:16px">下一步 →</button>
  </div>
</div>

<!-- T2 -->
<div id="T2" class="card hidden">
  <div class="step-title">T2 價格變動 <span class="pill">第二步</span></div>
  
  <div class="questions-section">
    <div style="padding:12px;background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;margin-bottom:16px">
      <p style="margin:0;color:#dc2626;font-weight:600">⚠️ 價格更新：從 NT$ 3,241 → NT$ 3,727 元 (↑ 15%)</p>
    </div>

    <div class="question-card">
      <div class="qline"><b>1) 你覺得這次漲價的主因：</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t2_locus" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">外在因素</span></label>
        <label class="cell"><input type="radio" name="t2_locus" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t2_locus" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t2_locus" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="t2_locus" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t2_locus" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t2_locus" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">內在因素</span></label>
      </div>
    </div>

    <div class="question-card">
      <div class="qline"><b>2) 你覺得這次漲價是：</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t2_control" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">不可控</span></label>
        <label class="cell"><input type="radio" name="t2_control" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t2_control" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t2_control" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="t2_control" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t2_control" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t2_control" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">可控制</span></label>
      </div>
    </div>

    <div class="question-card">
      <div class="qline"><b>3) 你感到不高興的程度：</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t2_upset" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">完全不會</span></label>
        <label class="cell"><input type="radio" name="t2_upset" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t2_upset" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t2_upset" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="t2_upset" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t2_upset" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t2_upset" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">非常不爽</span></label>
      </div>
    </div>

    <button class="btn" id="t2_next">下一步 →</button>
  </div>
</div>

<!-- T3 -->
<div id="T3" class="card hidden">
  <div class="step-title">T3 價格透明說明 <span class="pill">第三步</span></div>
  
  <div class="questions-section">
    <div style="padding:16px;background:#eff6ff;border:1px solid #93c5fd;border-radius:8px;margin-bottom:16px;color:#1e40af">
      <b>💡 說明：</b> 本平台採動態定價，依「剩餘房數、近期瀏覽量、同區域平均價格」即時調整。目前此時段：剩餘房數減少、瀏覽量上升。
    </div>

    <div class="question-card">
      <div class="qline"><b>1) 現在你覺得價格是公平的：</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t3_fair" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">非常不同意</span></label>
        <label class="cell"><input type="radio" name="t3_fair" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t3_fair" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t3_fair" value="4"><span>4</span><span style="font-size:11px;margin-top:2px">中立</span></label>
        <label class="cell"><input type="radio" name="t3_fair" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t3_fair" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t3_fair" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">非常同意</span></label>
      </div>
    </div>

    <div class="question-card">
      <div class="qline"><b>2) 你的購買意願是否提升：</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t3_intent" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">明顯下降</span></label>
        <label class="cell"><input type="radio" name="t3_intent" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t3_intent" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t3_intent" value="4"><span>4</span><span style="font-size:11px;margin-top:2px">無變化</span></label>
        <label class="cell"><input type="radio" name="t3_intent" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t3_intent" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t3_intent" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">明顯提升</span></label>
      </div>
    </div>

    <button class="btn" id="t3_next">進入最後一步 →</button>
  </div>
</div>

<!-- T3_check 操弄檢核 -->
<div id="T3_check" class="card hidden">
  <div class="step-title">確認您的理解 <span class="pill">檢核</span></div>
  
  <p class="muted">在進行最後決定前，我們想確認您對剛才說明的理解。</p>
  
  <div class="questions-section">
    <div class="question-card">
      <div class="qline"><b>1) 我理解平台為何調價：</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="check_understand" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">完全不理解</span></label>
        <label class="cell"><input type="radio" name="check_understand" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="check_understand" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="check_understand" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="check_understand" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="check_understand" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="check_understand" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">完全理解</span></label>
      </div>
    </div>

    <div class="question-card">
      <div class="qline"><b>2) 我覺得這份說明清楚易懂：</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="check_clarity" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">完全不清楚</span></label>
        <label class="cell"><input type="radio" name="check_clarity" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="check_clarity" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="check_clarity" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="check_clarity" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="check_clarity" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="check_clarity" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">非常清楚</span></label>
      </div>
    </div>

    <button class="btn" id="t3_check_next" style="margin-top:16px">進入最後決定 →</button>
  </div>
</div>

<!-- T4 -->
<div id="T4" class="card hidden">
  <div class="step-title">T4 最終決策 <span class="pill">第四步</span></div>
  
  <div class="questions-section">
    <div class="question-card">
      <div class="qline"><b>1) 整體來說，你覺得這個價格是公平的：</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t4_fair" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">非常同意</span></label>
        <label class="cell"><input type="radio" name="t4_fair" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t4_fair" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t4_fair" value="4"><span>4</span><span style="font-size:11px;margin-top:2px">中立</span></label>
        <label class="cell"><input type="radio" name="t4_fair" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t4_fair" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t4_fair" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">非常不同意</span></label>
      </div>
    </div>

    <div class="question-card">
      <div class="qline"><b>2) 你現在的購買意願：</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t4_intent" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">非常願意</span></label>
        <label class="cell"><input type="radio" name="t4_intent" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t4_intent" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t4_intent" value="4"><span>4</span><span style="font-size:11px;margin-top:2px">中立</span></label>
        <label class="cell"><input type="radio" name="t4_intent" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t4_intent" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t4_intent" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">非常不願意</span></label>
      </div>
    </div>

    <div class="row" style="margin-top:20px">
      <button class="btn" id="btn_checkout">✓ 我會購買</button>
      <button class="btn secondary" id="btn_abandon">✗ 我不買</button>
    </div>
    <div id="done" class="ok hidden" style="margin-top:12px;font-size:16px">✓ 已完成,感謝！</div>
  </div>
</div>

<script type="module">
  const q=(s)=>document.querySelector(s);
  const show=(id)=>q('#'+id).classList.remove('hidden');
  const hide=(id)=>q('#'+id).classList.add('hidden');
  const getRadio=(name)=>{const el=document.querySelector(`input[name="${name}"]:checked`);return el?Number(el.value):null;};

  const SUPABASE_URL = "https://hcsbwmeseeerugeotsow.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhjc2J3bWVzZWVlcnVnZW90c293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNjA4MjQsImV4cCI6MjA3NTgzNjgyNH0.3CP5szKNc5wMq9L4xO70wxlyMxT3YpK_5gg7i3TAx38";
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let SESSION_ID=null;

  async function startSession(){
    const { data, error } = await supabase.from('sessions').insert([{scenario:'hotel'}]).select('session_id').single();
    if(error){ console.log('連線失敗:'+error.message); return null; }
    SESSION_ID=data.session_id;
    return SESSION_ID;
  }

  async function logSurvey(step,qid,ans=null,txt=null){
    if(!SESSION_ID) return;
    await supabase.from('surveys').insert([{ session_id: SESSION_ID, step, qid, answer_numeric: ans, answer_text: txt }]);
  }

  /* T0 */
  q('#t0_next').addEventListener('click', async ()=>{
    const gender = q('#t0_gender').value;
    const age = q('#t0_age').value;
    if(!gender || !age){ alert('請選擇性別和年齡'); return; }
    hide('T0'); 
    show('T1');
  });

  /* T1 → T2 */
  q('#t1_next').addEventListener('click', async ()=>{
    const desire=getRadio('t1_intent_desire'); 
    const action=getRadio('t1_intent_action');
    const attention=getRadio('attention_check');
    if(desire==null||action==null||attention==null){ alert('請完成全部題目喔'); return; }
    await logSurvey('T1','t1_intent_desire',desire,null);
    await logSurvey('T1','t1_intent_action',action,null);
    await logSurvey('T1','attention_check',attention,null);
    hide('T1'); 
    show('T2');
  });

  /* T2 → T3 */
  q('#t2_next').addEventListener('click', async ()=>{
    const locus=getRadio('t2_locus'); 
    const ctrl=getRadio('t2_control'); 
    const upset=getRadio('t2_upset');
    if(locus==null||ctrl==null||upset==null){ alert('請完成三題喔'); return; }
    await logSurvey('T2','t2_attrib_locus',locus,null);
    await logSurvey('T2','t2_attrib_control',ctrl,null);
    await logSurvey('T2','t2_emotion_upset',upset,null);
    hide('T2'); 
    show('T3');
  });

  /* T3 → T3_check */
  q('#t3_next').addEventListener('click', async ()=>{
    const fair=getRadio('t3_fair'); 
    const intent=getRadio('t3_intent');
    if(fair==null||intent==null){ alert('請完成兩題喔'); return; }
    await logSurvey('T3','t3_fairness',fair,null);
    await logSurvey('T3','t3_intent',intent,null);
    hide('T3'); 
    show('T3_check');
  });

  /* T3_check → T4 */
  q('#t3_check_next').addEventListener('click', async ()=>{
    const understand=getRadio('check_understand'); 
    const clarity=getRadio('check_clarity');
    if(understand==null||clarity==null){ alert('請完成兩題喔'); return; }
    await logSurvey('T3','check_understand',understand,null);
    await logSurvey('T3','check_clarity',clarity,null);
    hide('T3_check'); 
    show('T4');
  });

  /* T4 提交 */
  async function submitT4(){
    const fair=getRadio('t4_fair'); 
    const intent=getRadio('t4_intent');
    if(fair==null||intent==null){ alert('請先完成兩題'); return; }
    await logSurvey('T4','t4_overall_fairness',fair,null);
    await logSurvey('T4','t4_final_intent',intent,null);
    q('#done').classList.remove('hidden');
  }

  q('#btn_checkout').addEventListener('click', submitT4);
  q('#btn_abandon').addEventListener('click', submitT4);

  /* 啟動 */
  const ok = await startSession();
  show('T0');
</script>
</body>
</html>
