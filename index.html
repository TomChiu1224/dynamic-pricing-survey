<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ¨¡æ“¬è¨‚æˆ¿(å››éšæ®µå‹•æ…‹é‡æ¸¬)+T0åŸºæœ¬è³‡æ–™(å°ç£ç‰ˆ)</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial;padding:20px;line-height:1.6;background:#f5f5f5;max-width:1400px;margin:0 auto}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:12px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #111827;background:#111827;color:#fff;cursor:pointer;font-size:14px;transition:all 0.2s}
    .btn:hover{background:#374151}
    .btn.secondary{background:#fff;color:#111827}
    .btn.secondary:hover{background:#f3f4f6}
    .muted{color:#6b7280;font-size:14px}
    .hidden{display:none}
    .step-title{font-weight:700;font-size:18px;margin-bottom:8px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #e5e7eb;border-radius:999px;font-size:12px;background:#fff}
    .ok{color:#10b981;font-weight:700}
    select,input[type="text"]{padding:8px;border:1px solid #e5e7eb;border-radius:8px;min-width:220px}
    .w-full{min-width:320px;width:320px}

    /* 7é»é‡è¡¨ */
    .likert{display:grid;grid-template-columns:repeat(7,56px);gap:8px;align-items:flex-start;margin:6px 0;}
    .likert .cell{display:flex;flex-direction:column;align-items:center;font-size:13px;min-height:60px}
    .likert input[type="radio"]{margin:0 0 4px 0;transform:scale(1.1);cursor:pointer}
    .likert .cell span:last-child{display:block;min-height:32px;text-align:center;line-height:1.2;margin-top:2px}
    .qline{display:flex;align-items:center;gap:8px;margin-top:12px}
    .hint{color:#6b7280;font-size:13px;white-space:nowrap}

    /* é£¯åº—è³‡è¨Šå¡ç‰‡ - å›ºå®šé¡¯ç¤ºåœ¨æ‰€æœ‰éšæ®µ */
    .hotel-info-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:20px}
    
    /* åœ–ç‰‡è¼ªæ’­å€ */
    .carousel-container{position:relative;width:100%;height:500px;overflow:hidden;background:#000}
    .carousel-slides{display:flex;transition:transform 0.4s ease-in-out;height:100%}
    .carousel-slide{min-width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    .carousel-slide img{width:100%;height:100%;object-fit:contain;background:#f5f5f5}
    .carousel-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.6);color:#fff;border:none;padding:12px 16px;cursor:pointer;font-size:20px;z-index:10;transition:all 0.2s;border-radius:4px}
    .carousel-btn:hover{background:rgba(0,0,0,0.8)}
    .carousel-btn.prev{left:10px}
    .carousel-btn.next{right:10px}
    
    /* ç¸®åœ–å°èˆª */
    .thumbs-nav{display:flex;gap:8px;padding:12px;background:#fafafa;overflow-x:auto;justify-content:center}
    .thumb-item{min-width:100px;width:100px;height:70px;cursor:pointer;border:3px solid transparent;border-radius:8px;overflow:hidden;transition:all 0.2s;background:#fff}
    .thumb-item:hover{transform:scale(1.05);box-shadow:0 2px 8px rgba(0,0,0,0.15)}
    .thumb-item.active{border-color:#059669;box-shadow:0 2px 12px rgba(5,150,105,0.3)}
    .thumb-item img{width:100%;height:100%;object-fit:cover}
    
    /* é£¯åº—è©³ç´°è³‡è¨Š */
    .hotel-details{padding:20px}
    .hotel-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;flex-wrap:wrap;gap:12px}
    .hotel-title{font-size:22px;font-weight:800;color:#111827;margin-bottom:4px}
    .hotel-subtitle{color:#6b7280;font-size:15px}
    .price-section{text-align:right}
    .price-label{font-size:15px;color:#6b7280;font-weight:500}
    .price-big{font-size:32px;font-weight:800;color:#059669}
    .price-original{font-size:16px;color:#9ca3af;text-decoration:line-through}
    
    .hotel-rating{display:flex;align-items:center;gap:8px;margin:12px 0}
    .stars{color:#f59e0b;font-size:18px}
    .rating-text{color:#6b7280;font-size:14px}
    
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin:16px 0}
    .badge{border:1px solid #86efac;border-radius:999px;padding:6px 12px;font-size:13px;background:#dcfce7;color:#059669}
    .badge.highlight{background:#bbf7d0;border-color:#4ade80;font-weight:600}
    
    .info-row{display:flex;align-items:center;gap:6px;margin:8px 0;color:#374151;font-size:14px}
    .info-row .icon{font-size:16px}
    
    /* å•é¡Œå€åŸŸ */
    .questions-section{background:#f9fafb;padding:20px;border-radius:12px;border:1px solid #e5e7eb}
    .question-card{background:#fff;padding:16px;border-radius:8px;margin:12px 0;border:1px solid #e5e7eb}

    /* T4 é¸é …å¡ç‰‡æ¨£å¼ */
    .slider-option{flex:1;text-align:center;padding:12px;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all 0.2s;background:#fff}
    .slider-option:hover{border-color:#059669;background:#f0fdf4}
    .slider-option input[type="radio"]{display:none}

    @media (max-width: 768px){
      .carousel-container{height:350px}
      .hotel-header{flex-direction:column}
      .price-section{text-align:left}
      .thumb-item{min-width:80px;width:80px;height:56px}
    }
  </style>
</head>
<body>

<div class="topbar">
  <h1 style="margin:0">æ¨¡æ“¬è¨‚æˆ¿(å››éšæ®µå‹•æ…‹é‡æ¸¬)</h1>
  <button class="btn hidden" id="btn_export">ğŸ“¥ åŒ¯å‡ºè³‡æ–™(CSV)</button>
</div>
<p class="muted">è«‹ä¾åºå®Œæˆ:<b>T0åŸºæœ¬è³‡æ–™ â†’ T1 â†’ T2 â†’ T3 â†’ T4</b>ã€‚æ¯ä¸€æ­¥åªæœ‰ 1â€”3 é¡Œ,å®Œæˆå¾ŒæŒ‰ä¸‹ä¸€æ­¥ã€‚</p>

<hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0"/>

<!-- ç®¡ç†å“¡ç™»å…¥å€ (éš±è—) -->
<div id="admin-login" class="hidden" style="position:fixed;top:10px;right:10px;z-index:1000;background:white;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15)">
  <div style="margin-bottom:8px;font-size:13px;color:#374151;font-weight:600">ğŸ” ç®¡ç†å“¡ç™»å…¥</div>
  <input type="password" id="admin-password" placeholder="è¼¸å…¥ç®¡ç†å¯†ç¢¼" style="padding:6px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px;width:120px">
  <button onclick="checkAdminPassword()" style="padding:6px 10px;background:#059669;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;margin-left:4px">ç™»å…¥</button>
</div>

<div id="status" class="muted">å°šæœªé–‹å§‹</div>

<!-- T0 åŸºæœ¬è³‡æ–™ -->
<div id="T0" class="card hidden">
  <div class="step-title">T0 åŸºæœ¬è³‡æ–™ <span class="pill">ç¬¬é›¶æ­¥</span></div>
  
  <!-- ç®¡ç†å“¡å°ˆç”¨ï¼šåŒ¯å‡ºè³‡æ–™æŒ‰éˆ• -->
  <div id="admin-panel" class="hidden" style="background:#f0fdf4;border:2px solid #86efac;border-radius:8px;padding:16px;margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div>
        <div style="font-weight:700;color:#059669;margin-bottom:4px">ğŸ” ç®¡ç†å“¡æ¨¡å¼å·²å•Ÿç”¨</div>
        <div style="font-size:13px;color:#166534">å¯åŒ¯å‡ºæ‰€æœ‰å—æ¸¬è€…è³‡æ–™ï¼ˆsessions, demographics, events, surveys, ordersï¼‰</div>
      </div>
      <button class="btn" id="btn_export_admin" style="background:#059669;border-color:#059669">ğŸ“¥ ä¸€éµåŒ¯å‡ºå…¨éƒ¨è¡¨æ ¼</button>
    </div>
  </div>
  
  <p class="muted">ä»¥ä¸‹è³‡æ–™åƒ…åšå­¸è¡“ç ”ç©¶,å»è­˜åˆ¥åŒ–ä¿å­˜ã€‚</p>

  <div class="row">
    <div>
      <div>1) æ€§åˆ¥</div>
      <select id="t0_gender">
        <option value="">è«‹é¸æ“‡</option>
        <option value="male">ç”·æ€§</option>
        <option value="female">å¥³æ€§</option>
        <option value="nonbinary">éäºŒå…ƒæ€§åˆ¥</option>
        <option value="prefer_not">ä¸é¡˜é€éœ²</option>
      </select>
    </div>

    <div>
      <div>2) å¹´é½¡å€é–“</div>
      <select id="t0_age">
        <option value="">è«‹é¸æ“‡</option>
        <option value="<18">18 æ­²ä»¥ä¸‹</option>
        <option value="18-24">18â€”24 æ­²</option>
        <option value="25-34">25â€”34 æ­²</option>
        <option value="35-44">35â€”44 æ­²</option>
        <option value="45-54">45â€”54 æ­²</option>
        <option value="55-64">55â€”64 æ­²</option>
        <option value="65+">65 æ­²ä»¥ä¸Š</option>
        <option value="prefer_not">ä¸é¡˜é€éœ²</option>
      </select>
    </div>

    <div>
      <div>3) è·æ¥­(å°ç£å¸¸è¦‹é¡åˆ¥)</div>
      <select id="t0_job_select" class="w-full">
        <option value="">è«‹é¸æ“‡</option>
        <option>å­¸ç”Ÿ</option><option>è»å…¬æ•™</option><option>æ•™è‚²/ç ”ç©¶</option><option>é†«ç™‚/è­·ç†</option>
        <option>è³‡è¨Šç§‘æŠ€</option><option>é‡‘è/ä¿éšª</option><option>è£½é€ æ¥­/å·¥æ¥­</option><option>ç‡Ÿå»º/åœŸæœ¨/ä¸å‹•ç”¢</option>
        <option>æ‰¹ç™¼é›¶å”®/é–€å¸‚/éŠ·å”®</option><option>è¡ŒéŠ·/å°ˆæ¡ˆ/ä¼åŠƒ</option><option>é¤é£²/æ—…å®¿/è§€å…‰</option>
        <option>é‹è¼¸/å€‰å„²/ç‰©æµ</option><option>æœå‹™æ¥­(ç™¾è²¨ã€å®¢æœç­‰)</option><option>æ–‡å‰µ/è¨­è¨ˆ/åª’é«”</option>
        <option>è¾²æ—æ¼ç‰§</option><option>è‡ªç”±æ¥­/æ¥æ¡ˆ</option><option>å®¶åº­ä¸»å©¦/ä¸»å¤«</option><option>é€€ä¼‘</option>
        <option>å¾…æ¥­/æ±‚è·ä¸­</option><option value="other">å…¶ä»–(è«‹å¡«å¯«)</option><option value="prefer_not">ä¸é¡˜é€éœ²</option>
      </select>
      <div id="t0_job_other_wrap" class="hidden" style="margin-top:6px">
        <input type="text" id="t0_job_other" class="w-full" placeholder="è«‹è¼¸å…¥è·æ¥­æˆ–è¡Œæ¥­">
      </div>
    </div>

    <div>
      <div>4) å¹´æ”¶å…¥å€é–“</div>
      <select id="t0_income">
        <option value="">è«‹é¸æ“‡</option>
        <option value="<50è¬">ä½æ–¼ 50 è¬</option>
        <option value="50â€”100è¬">50â€”100 è¬</option>
        <option value="100â€”200è¬">100â€”200 è¬</option>
        <option value="200è¬+">200 è¬ä»¥ä¸Š</option>
        <option value="prefer_not">ä¸é¡˜é€éœ²</option>
      </select>
    </div>

    <div>
      <div>5) æ•™è‚²ç¨‹åº¦</div>
      <select id="t0_edu">
        <option value="">è«‹é¸æ“‡</option>
        <option value="åœ‹ä¸­ä»¥ä¸‹">åœ‹ä¸­ä»¥ä¸‹</option>
        <option value="é«˜ä¸­è·">é«˜ä¸­/é«˜è·</option>
        <option value="å¤§å­¸/å¤§å°ˆ">å¤§å­¸/å¤§å°ˆ</option>
        <option value="ç ”ç©¶æ‰€">ç ”ç©¶æ‰€</option>
        <option value="åšå£«">åšå£«</option>
        <option value="prefer_not">ä¸é¡˜é€éœ²</option>
      </select>
    </div>
  </div>

  <div style="margin-top:12px">
    <button class="btn" id="t0_next">é–‹å§‹å¯¦é©—(é€²å…¥ T1)</button>
  </div>
</div>

<!-- é£¯åº—è³‡è¨Šå¡ç‰‡çµ„ä»¶æ¨¡æ¿ (æœƒåœ¨ T1-T4 é‡è¤‡ä½¿ç”¨) -->
<template id="hotel-info-template">
  <div class="hotel-info-card">
    <!-- åœ–ç‰‡è¼ªæ’­ -->
    <div class="carousel-container">
      <button class="carousel-btn prev">â€¹</button>
      <button class="carousel-btn next">â€º</button>
      <div class="carousel-slides">
        <div class="carousel-slide"><img src="https://drive.google.com/thumbnail?id=19jD0gcMNJutsnZ-wzM_Jt1s4D-GFhkHF&sz=w1200" alt="é•·æ¦®æ¡‚å† é…’åº—å¤–è§€"></div>
        <div class="carousel-slide"><img src="https://drive.google.com/thumbnail?id=1Rnj8oHYsDz0nZY-bSwp8-bL8WeE7NqgB&sz=w1200" alt="é«˜ç´šé›™äººæˆ¿"></div>
        <div class="carousel-slide"><img src="https://drive.google.com/thumbnail?id=1vcSCGIxPwO1FujP-Y9x-ZGPbaIQooCg7&sz=w1200" alt="å®¢æˆ¿å…§éƒ¨"></div>
        <div class="carousel-slide"><img src="https://drive.google.com/thumbnail?id=1tPhdEHQRt8Iuuki9SAI2NfPXlhIjasXh&sz=w1200" alt="è±ªè¯æˆ¿å‹"></div>
        <div class="carousel-slide"><img src="https://drive.google.com/thumbnail?id=1tA6oq4Fp9xnS6lsKY_jvUYC0AFkzW02D&sz=w1200" alt="æµ´å®¤è¨­æ–½"></div>
        <div class="carousel-slide"><img src="https://drive.google.com/thumbnail?id=1DHtMAGjasDx8BB40gynGm9_D3c0czju5&sz=w1200" alt="æˆ¿é–“è¨­å‚™"></div>
      </div>
    </div>
    
    <!-- ç¸®åœ–å°èˆª -->
    <div class="thumbs-nav">
      <div class="thumb-item active" data-index="0"><img src="https://drive.google.com/thumbnail?id=19jD0gcMNJutsnZ-wzM_Jt1s4D-GFhkHF&sz=w200" alt="å¤–è§€"></div>
      <div class="thumb-item" data-index="1"><img src="https://drive.google.com/thumbnail?id=1Rnj8oHYsDz0nZY-bSwp8-bL8WeE7NqgB&sz=w200" alt="é›™äººæˆ¿"></div>
      <div class="thumb-item" data-index="2"><img src="https://drive.google.com/thumbnail?id=1vcSCGIxPwO1FujP-Y9x-ZGPbaIQooCg7&sz=w200" alt="å®¢æˆ¿"></div>
      <div class="thumb-item" data-index="3"><img src="https://drive.google.com/thumbnail?id=1tPhdEHQRt8Iuuki9SAI2NfPXlhIjasXh&sz=w200" alt="è±ªè¯æˆ¿"></div>
      <div class="thumb-item" data-index="4"><img src="https://drive.google.com/thumbnail?id=1tA6oq4Fp9xnS6lsKY_jvUYC0AFkzW02D&sz=w200" alt="æµ´å®¤"></div>
      <div class="thumb-item" data-index="5"><img src="https://drive.google.com/thumbnail?id=1DHtMAGjasDx8BB40gynGm9_D3c0czju5&sz=w200" alt="è¨­å‚™"></div>
    </div>
    
    <!-- é£¯åº—è©³ç´°è³‡è¨Š -->
    <div class="hotel-details">
      <div class="hotel-header">
        <div>
          <div class="hotel-title">é•·æ¦®æ¡‚å† é…’åº— - å°ä¸­ Evergreen Laurel Hotel Taichung</div>
          <div class="hotel-subtitle">é«˜ç´šé›™äººæˆ¿ (Superior Double Bed) ï½œ30å¹³æ–¹å…¬å°º/323å¹³æ–¹è‹±å°ºï½œ1å¼µé›™äººåºŠ</div>
        </div>
        <div class="price-section">
          <div class="price-label">å¹³æ—¥(é€±ä¸€åˆ°é€±å››)å”®åƒ¹</div>
          <div class="price-big">NT$ <span id="current-price">3,241</span></div>
        </div>
      </div>
      
      <div class="hotel-rating">
        <span class="stars">â˜…â˜…â˜…â˜…â˜…</span>
        <span class="rating-text">8.9 å¾ˆè®š (17,233 å‰‡è©•è«–)</span>
      </div>
      
      <div class="badges">
        <span class="badge">âœ“ é™„æ—©é¤</span>
        <span class="badge">âœ“ 2025å¹´10æœˆ20æ—¥ æ˜ŸæœŸä¸€å‰å¯å…è²»å–æ¶ˆ</span>
        <span class="badge">âœ“ å¯å»¶è‡³2025å¹´10æœˆ18æ—¥ æ˜ŸæœŸå…­æ‰£æ¬¾</span>
        <span class="badge">âœ“ åœè»Š</span>
        <span class="badge">âœ“ å…è²» Wi-Fi</span>
        <span class="badge">âœ“ å¥èº«ä¸­å¿ƒ</span>
      </div>
      
      <div class="info-row">
        <span class="icon">ğŸ“</span>
        <span>å°ç£å¤§é“äºŒæ®µ666è™Ÿ, è¥¿å±¯å€, å°ä¸­å¸‚, å°ç£, 407 - <a href="https://maps.app.goo.gl/NsShf1o18wPhJ2cu5" target="_blank" style="color:#059669;text-decoration:underline">æŸ¥çœ‹åœ°åœ–èˆ‡å‘¨é‚Šè¨­æ–½</a></span>
      </div>
      
      <div class="info-row">
        <span class="icon">ğŸ•</span>
        <span>å…¥ä½ 15:00 èµ· ï½œ é€€æˆ¿ 12:00 å‰</span>
      </div>
      
      <div class="info-row">
        <span class="icon">ğŸ¨</span>
        <span>å®¢æˆ¿é¢ç©ï¼š30å¹³æ–¹å…¬å°º ï½œ 1å¼µé›™äººåºŠ ï½œ æµ´ç¼¸ ï½œ é®å…‰çª—ç°¾ ï½œ å…è²»ç›¥æ´—ç”¨å“ ï½œ Mini Bar ï½œ å¹é¢¨æ©Ÿ ï½œ æµ´ç¼¸ ï½œ æµ´è¢</span>
      </div>
      
      <div class="info-row">
        <span class="icon">âœ¨</span>
        <span><b>é£¯åº—è¨­æ–½ï¼š</b>å…è²»Wi-Fiã€æ™¯è§€æ³³æ± ã€å…è²»åœè»Šã€Spaã€é…’å§ã€24å°æ™‚æ«ƒå°æœå‹™ã€å¥èº«ä¸­å¿ƒã€é¤å»³</span>
      </div>
      
      <div class="info-row">
        <span class="icon">ğŸ½ï¸</span>
        <span><b>é¤é£²æœå‹™ï¼š</b>24å°æ™‚é€é¤æœå‹™ã€å’–å•¡å»³ã€é€é¤æœå‹™ã€ç¾é«®æ²™é¾ã€å¥èº«æˆ¿ã€Spa</span>
      </div>
      
      <div class="info-row">
        <span class="icon">ğŸ›ï¸</span>
        <span><b>æˆ¿é–“è¨­æ–½ï¼š</b>æ†æº«æ°´å£ºã€å¹é¢¨æ©Ÿã€æµ´ç¼¸ã€å°ˆç”¨è¡›æµ´ã€æ·‹æµ´è¨­å‚™ã€éš”éŸ³è¨­æ–½ã€å®¤å…§æ‹–é‹ã€é®å…‰çª—ç°¾ã€ç›¥æ´—ç”¨å“ã€é›»è¦–ã€å…è²»æœ‰ç·šä¸Šç¶²ã€é›»è©±ã€è¡›æ˜Ÿé »é“/æœ‰ç·šé›»è¦–ã€å†°ç®±ã€Mini Barã€å…è²»å³æº¶å’–å•¡ã€å†°ç®±ã€æ³³è¡£/æ³³è£è¨­å‚™ã€åœ°æ¯¯ã€éŸ³éŸ¿ã€è¡£æ«ƒã€ç†¨ç‡™è¨­å‚™</span>
      </div>
      
      <div style="margin-top:12px;padding:12px;background:#f0fdf4;border:1px solid #86efac;border-radius:8px">
        <div style="color:#059669;font-weight:600;margin-bottom:4px">ğŸ’³ å…¨å°å°ˆå±¬</div>
        <div style="font-size:13px;color:#166534">â€¢ é™„æ—©é¤ï½œå…è²»Wi-Fiï½œå¥èº«ä¸­å¿ƒï½œåœè»Š</div>
      </div>
    </div>
  </div>
</template>

<!-- T1 -->
<div id="T1" class="card hidden">
  <div class="step-title">T1 åˆè¦‹åƒ¹æ ¼ <span class="pill">ç¬¬ä¸€æ­¥</span></div>
  
  <div id="hotel-info-t1"></div>
  
  <div class="questions-section">
    <p style="margin-top:0"><b>ã€é«˜ç´šé›™äººæˆ¿ã€‘</b> ä»Šæ—¥åƒ¹æ ¼ï¼š<b id="price_t1">3,241</b> å…ƒ</p>

    <div class="question-card">
  <div class="qline"><b>1) ä½ æƒ³è¦è³¼è²·çš„ç¨‹åº¦ï¼š</b></div>
  <div class="likert">
    <label class="cell"><input type="radio" name="t1_intent_desire" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">å®Œå…¨ä¸æƒ³</span></label>
    <label class="cell"><input type="radio" name="t1_intent_desire" value="2"><span>2</span></label>
    <label class="cell"><input type="radio" name="t1_intent_desire" value="3"><span>3</span></label>
    <label class="cell"><input type="radio" name="t1_intent_desire" value="4"><span>4</span></label>
    <label class="cell"><input type="radio" name="t1_intent_desire" value="5"><span>5</span></label>
    <label class="cell"><input type="radio" name="t1_intent_desire" value="6"><span>6</span></label>
    <label class="cell"><input type="radio" name="t1_intent_desire" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">éå¸¸æƒ³è²·</span></label>
  </div>
</div>

<div class="question-card">
  <div class="qline"><b>2) å‡è¨­ç¾åœ¨å°±è¦æ±ºå®šï¼Œä½ æœƒè³¼è²·é€™é–“æˆ¿é–“å—ï¼Ÿ</b></div>
  <div class="likert">
    <label class="cell"><input type="radio" name="t1_intent_action" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">çµ•å°ä¸æœƒ</span></label>
    <label class="cell"><input type="radio" name="t1_intent_action" value="2"><span>2</span></label>
    <label class="cell"><input type="radio" name="t1_intent_action" value="3"><span>3</span></label>
    <label class="cell"><input type="radio" name="t1_intent_action" value="4"><span>4</span></label>
    <label class="cell"><input type="radio" name="t1_intent_action" value="5"><span>5</span></label>
    <label class="cell"><input type="radio" name="t1_intent_action" value="6"><span>6</span></label>
    <label class="cell"><input type="radio" name="t1_intent_action" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">ä¸€å®šæœƒ</span></label>
  </div>
</div>


<div class="question-card" style="background:#fff9e6;border:1px solid #fcd34d">
  <div class="qline"><b>âš ï¸ æ³¨æ„åŠ›æª¢æ ¸ï¼šè«‹é¸æ“‡ã€Œ3ã€</b></div>
  <div class="muted" style="margin-bottom:8px">è«‹ä»”ç´°é¸æ“‡æ­£ç¢ºçš„æ•¸å­—</div>
  <div class="likert">
    <label class="cell"><input type="radio" name="attention_check" value="1"><span>1</span></label>
    <label class="cell"><input type="radio" name="attention_check" value="2"><span>2</span></label>
    <label class="cell"><input type="radio" name="attention_check" value="3"><span>3</span><span style="font-size:11px;margin-top:2px;color:#dc2626;font-weight:600">âœ“</span></label>
    <label class="cell"><input type="radio" name="attention_check" value="4"><span>4</span></label>
    <label class="cell"><input type="radio" name="attention_check" value="5"><span>5</span></label>
    <label class="cell"><input type="radio" name="attention_check" value="6"><span>6</span></label>
    <label class="cell"><input type="radio" name="attention_check" value="7"><span>7</span></label>
  </div>
</div>

    <button class="btn" id="t1_next" style="margin-top:16px">ä¸‹ä¸€æ­¥ â†’</button>
  </div>
</div>

<!-- T2 -->
<div id="T2" class="card hidden">
  <div class="step-title">T2 åƒ¹æ ¼è®Šå‹• <span class="pill">ç¬¬äºŒæ­¥</span></div>
  
  <div id="hotel-info-t2"></div>
  
  <div class="questions-section">
    <div style="padding:12px;background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;margin-bottom:16px">
      <p style="margin:0;color:#dc2626;font-weight:600">âš ï¸ éä¸‰å¤©å¾Œæ‚¨å†æ¬¡é€²å…¥é€™é é¢,åƒ¹æ ¼æ›´æ–°ï¼šå¾ <b id="t2_old_price">3,241</b> â†’ <b id="price_t2">3,727</b> å…ƒ (â†‘ <span id="t2_pct">15</span>%)</p>
    </div>

    <div class="question-card">
      <div class="qline"><b>1) ä½ è¦ºå¾—é€™æ¬¡æ¼²åƒ¹çš„ä¸»å› ï¼š</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t2_locus" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">å¤–åœ¨å› ç´ </span></label>
        <label class="cell"><input type="radio" name="t2_locus" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t2_locus" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t2_locus" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="t2_locus" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t2_locus" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t2_locus" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">å…§åœ¨å› ç´ </span></label>
      </div>
    </div>

    <div class="question-card">
      <div class="qline"><b>2) ä½ è¦ºå¾—é€™æ¬¡æ¼²åƒ¹æ˜¯ï¼š</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t2_control" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">ä¸å¯æ§</span></label>
        <label class="cell"><input type="radio" name="t2_control" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t2_control" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t2_control" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="t2_control" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t2_control" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t2_control" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">å¯æ§åˆ¶</span></label>
      </div>
    </div>

    <div class="question-card">
      <div class="qline"><b>3) ä½ æ„Ÿåˆ°ä¸é«˜èˆˆçš„ç¨‹åº¦ï¼š</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t2_upset" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">å®Œå…¨ä¸æœƒ</span></label>
        <label class="cell"><input type="radio" name="t2_upset" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t2_upset" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t2_upset" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="t2_upset" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t2_upset" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t2_upset" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">éå¸¸ä¸çˆ½</span></label>
      </div>
    </div>

    <button class="btn" id="t2_next">ä¸‹ä¸€æ­¥(çœ‹èªªæ˜) â†’</button>
  </div>
</div>

<!-- T3 -->
<div id="T3" class="card hidden">
  <div class="step-title">T3 åƒ¹æ ¼é€æ˜èªªæ˜ <span class="pill">ç¬¬ä¸‰æ­¥</span></div>
  
  <div id="hotel-info-t3"></div>
  
  <div class="questions-section">
    <div id="transparency_block" style="padding:16px;background:#eff6ff;border:1px solid #93c5fd;border-radius:8px;margin-bottom:16px;color:#1e40af"></div>

    <div class="question-card">
      <div class="qline"><b>1) ç¾åœ¨ä½ è¦ºå¾—åƒ¹æ ¼æ˜¯å…¬å¹³çš„ï¼š</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t3_fair" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">éå¸¸ä¸åŒæ„</span></label>
        <label class="cell"><input type="radio" name="t3_fair" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t3_fair" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t3_fair" value="4"><span>4</span><span style="font-size:11px;margin-top:2px">ä¸­ç«‹</span></label>
        <label class="cell"><input type="radio" name="t3_fair" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t3_fair" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t3_fair" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">éå¸¸åŒæ„</span></label>
      </div>
    </div>

    <div class="question-card">
      <div class="qline"><b>2) ä½ çš„è³¼è²·æ„é¡˜æ˜¯å¦æå‡ï¼š</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t3_intent" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">æ˜é¡¯ä¸‹é™</span></label>
        <label class="cell"><input type="radio" name="t3_intent" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t3_intent" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t3_intent" value="4"><span>4</span><span style="font-size:11px;margin-top:2px">ç„¡è®ŠåŒ–</span></label>
        <label class="cell"><input type="radio" name="t3_intent" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t3_intent" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t3_intent" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">æ˜é¡¯æå‡</span></label>
      </div>
    </div>

    <button class="btn" id="t3_next">é€²å…¥æœ€å¾Œä¸€æ­¥ â†’</button>
  </div>
</div>

<!-- T3_check æ“å¼„æª¢æ ¸ -->
<div id="T3_check" class="card hidden">
  <div class="step-title">ç¢ºèªæ‚¨çš„ç†è§£ <span class="pill">æª¢æ ¸</span></div>
  
  <p class="muted">åœ¨é€²è¡Œæœ€å¾Œæ±ºå®šå‰ï¼Œæˆ‘å€‘æƒ³ç¢ºèªæ‚¨å°å‰›æ‰èªªæ˜çš„ç†è§£ã€‚</p>
  
  <div class="questions-section">
    <div class="question-card">
      <div class="qline"><b>1) æˆ‘ç†è§£å¹³å°ç‚ºä½•èª¿åƒ¹ï¼š</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="check_understand" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">å®Œå…¨ä¸ç†è§£</span></label>
        <label class="cell"><input type="radio" name="check_understand" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="check_understand" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="check_understand" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="check_understand" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="check_understand" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="check_understand" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">å®Œå…¨ç†è§£</span></label>
      </div>
    </div>

    <div class="question-card">
      <div class="qline"><b>2) æˆ‘è¦ºå¾—é€™ä»½èªªæ˜æ¸…æ¥šæ˜“æ‡‚ï¼š</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="check_clarity" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">å®Œå…¨ä¸æ¸…æ¥š</span></label>
        <label class="cell"><input type="radio" name="check_clarity" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="check_clarity" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="check_clarity" value="4"><span>4</span></label>
        <label class="cell"><input type="radio" name="check_clarity" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="check_clarity" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="check_clarity" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">éå¸¸æ¸…æ¥š</span></label>
      </div>
    </div>

    <button class="btn" id="t3_check_next" style="margin-top:16px">é€²å…¥æœ€å¾Œæ±ºå®š â†’</button>
  </div>
</div>





<!-- T4 -->
<div id="T4" class="card hidden">
  <div class="step-title">T4 æœ€çµ‚æ±ºç­– <span class="pill">ç¬¬å››æ­¥</span></div>
  
  <div id="hotel-info-t4"></div>
  
  <div class="questions-section">
    <div class="question-card">
      <div class="qline"><b>1) æ•´é«”ä¾†èªª,ä½ è¦ºå¾—é€™å€‹åƒ¹æ ¼æ˜¯å…¬å¹³çš„ï¼š</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t4_fair" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">éå¸¸åŒæ„</span></label>
        <label class="cell"><input type="radio" name="t4_fair" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t4_fair" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t4_fair" value="4"><span>4</span><span style="font-size:11px;margin-top:2px">ä¸­ç«‹</span></label>
        <label class="cell"><input type="radio" name="t4_fair" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t4_fair" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t4_fair" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">éå¸¸ä¸åŒæ„</span></label>
      </div>
    </div>

    <div class="question-card">
      <div class="qline"><b>2) ä½ ç¾åœ¨çš„è³¼è²·æ„é¡˜ï¼š</b></div>
      <div class="likert">
        <label class="cell"><input type="radio" name="t4_intent" value="1"><span>1</span><span style="font-size:11px;margin-top:2px">éå¸¸é¡˜æ„</span></label>
        <label class="cell"><input type="radio" name="t4_intent" value="2"><span>2</span></label>
        <label class="cell"><input type="radio" name="t4_intent" value="3"><span>3</span></label>
        <label class="cell"><input type="radio" name="t4_intent" value="4"><span>4</span><span style="font-size:11px;margin-top:2px">ä¸­ç«‹</span></label>
        <label class="cell"><input type="radio" name="t4_intent" value="5"><span>5</span></label>
        <label class="cell"><input type="radio" name="t4_intent" value="6"><span>6</span></label>
        <label class="cell"><input type="radio" name="t4_intent" value="7"><span>7</span><span style="font-size:11px;margin-top:2px">éå¸¸ä¸é¡˜æ„</span></label>
      </div>
    </div>

    <div style="margin:20px 0">
      <div style="margin-bottom:12px"><b>(å¯é¸) å“ªå€‹è³‡è¨Šæœ€å½±éŸ¿ä½ çš„æ±ºå®šï¼Ÿ</b></div>
      <div style="display:flex;gap:12px;align-items:stretch;max-width:600px">
        <label class="slider-option" data-value="0">
          <input type="radio" name="t4_reason" value="0">
          <div style="font-size:14px;font-weight:500">å‰©é¤˜æˆ¿æ•¸</div>
        </label>
        <label class="slider-option" data-value="50">
          <input type="radio" name="t4_reason" value="50">
          <div style="font-size:14px;font-weight:500">å…¶ä»–é£¯åº—åƒ¹æ ¼</div>
        </label>
        <label class="slider-option" data-value="100">
          <input type="radio" name="t4_reason" value="100">
          <div style="font-size:14px;font-weight:500">é€æ˜èªªæ˜</div>
        </label>
      </div>
    </div>

    <div class="row" style="margin-top:20px">
      <button class="btn" id="btn_checkout">âœ“ æˆ‘æœƒè³¼è²·(æ¨¡æ“¬ä¸‹å–®)</button>
      <button class="btn secondary" id="btn_abandon">âœ— æˆ‘ä¸è²·(é›¢é–‹)</button>
    </div>
    <div id="done" class="ok hidden" style="margin-top:12px;font-size:16px">âœ“ å·²å®Œæˆ,æ„Ÿè¬ï¼ä½ å¯ä»¥é—œé–‰é é¢ã€‚</div>
  </div>
</div>

<script type="module">
  /* ====== å¯¦é©—åƒæ•¸é›†ä¸­ç®¡ç† ====== */
  const EXPERIMENT_CONFIG = {
    prices: {
      T1: 3241,           // åˆå§‹åƒ¹æ ¼
      T2: 3727,           // æ¼²åƒ¹å¾Œåƒ¹æ ¼
      T2_original: 3241   // T2é¡¯ç¤ºçš„åŸåƒ¹åƒè€ƒ
    },
    inventory: {
      T1: 3,              // åˆå§‹å‰©é¤˜æˆ¿æ•¸
      T2: 2               // T2å‰©é¤˜æˆ¿æ•¸
    },
    priceChange: {
      absolute: 486,      // çµ•å°æ¼²å¹… (3727-3241)
      percentage: 0.15    // ç™¾åˆ†æ¯” 15%
    },
    competitor: {
      price: 3500         // ç«¶å“åƒ¹æ ¼ï¼ˆç”¨æ–¼T3èªªæ˜ï¼‰
    }
  };

  /* ====== Supabase é€£ç·š ====== */
  const SUPABASE_URL = "https://hcsbwmeseeerugeotsow.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhjc2J3bWVzZWVlcnVnZW90c293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNjA4MjQsImV4cCI6MjA3NTgzNjgyNH0.3CP5szKNc5wMq9L4xO70wxlyMxT3YpK_5gg7i3TAx38";
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ====== DOM å°å·¥å…· ====== */
  const q=(s)=>document.querySelector(s);
  const qa=(s)=>document.querySelectorAll(s);
  const show=(id)=>q('#'+id).classList.remove('hidden');
  const hide=(id)=>q('#'+id).classList.add('hidden');
  const getRadio=(name)=>{const el=document.querySelector(`input[name="${name}"]:checked`);return el?Number(el.value):null;};

  /* ====== åœ–ç‰‡è¼ªæ’­åŠŸèƒ½ ====== */
  let currentSlide = 0;
  const totalSlides = 6;

  function initCarousel(container) {
    const slides = container.querySelector('.carousel-slides');
    const prevBtn = container.querySelector('.carousel-btn.prev');
    const nextBtn = container.querySelector('.carousel-btn.next');
    const thumbs = container.querySelectorAll('.thumb-item');
    
    function goToSlide(index) {
      currentSlide = index;
      slides.style.transform = `translateX(-${currentSlide * 100}%)`;
      thumbs.forEach((thumb, i) => {
        thumb.classList.toggle('active', i === currentSlide);
      });
    }
    
    prevBtn.addEventListener('click', () => {
      currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
      goToSlide(currentSlide);
    });
    
    nextBtn.addEventListener('click', () => {
      currentSlide = (currentSlide + 1) % totalSlides;
      goToSlide(currentSlide);
    });
    
    thumbs.forEach((thumb, index) => {
      thumb.addEventListener('click', () => {
        goToSlide(index);
      });
    });
  }

  // å…‹éš†é£¯åº—è³‡è¨Šæ¨¡æ¿åˆ°å„éšæ®µ
  function insertHotelInfo(targetId) {
    const template = q('#hotel-info-template');
    const target = q('#' + targetId);
    const clone = template.content.cloneNode(true);
    target.appendChild(clone);
    initCarousel(target.querySelector('.hotel-info-card'));
  }

  // T0 å…¶ä»–è·æ¥­æ¬„é¡¯ç¤º
  document.addEventListener("change",(e)=>{
    if(e.target && e.target.id==="t0_job_select"){
      if(e.target.value==="other") q("#t0_job_other_wrap").classList.remove("hidden");
      else q("#t0_job_other_wrap").classList.add("hidden");
    }
  });

  /* ====== å¯¦é©—è¨­å®š ====== */
  const GROUPS=['A_low','B_mid','C_high'];
  const assigned_group=GROUPS[Math.floor(Math.random()*GROUPS.length)];
  const scenario='hotel';
  let SESSION_ID=null;

  const TRANSP={
    A_low:"ğŸ’¡ åƒ¹æ ¼æœƒä¾ä¸åŒæ™‚æ®µèˆ‡éœ€æ±‚è®ŠåŒ–è€Œèª¿æ•´ã€‚",
    B_mid:"ğŸ“Š ç›®å‰è©²æ—¥æœŸéœ€æ±‚å¢åŠ ã€å‰©é¤˜æˆ¿æ•¸æ¸›å°‘,åƒ¹æ ¼å› æ­¤ä¸Šèª¿ã€‚è‹¥æ›´æ”¹ç‚ºéå°–å³°æ—¥,åƒ¹æ ¼å¯èƒ½è¼ƒä½ã€‚",
    C_high:"ğŸ” æœ¬å¹³å°æ¡å‹•æ…‹å®šåƒ¹ï¼šä¾ã€å‰©é¤˜æˆ¿æ•¸ã€è¿‘æœŸç€è¦½é‡ã€åŒå€åŸŸå¹³å‡åƒ¹æ ¼ã€å³æ™‚èª¿æ•´ã€‚ç›®å‰æ­¤æ™‚æ®µï¼šå‰©é¤˜ 3â†’2 é–“ï¼›è¿‘ 2 å°æ™‚ç€è¦½é‡ +34%ï¼›åŒå€åŸŸå‡åƒ¹ 3,500 å…ƒï¼ˆæœ¬æˆ¿ç¾åƒ¹ 3,727ï¼‰ã€‚"
  };

  /* ====== DB å¯«å…¥å°è£ ====== */
  async function startSession(){
    const { data, error } = await supabase.from('sessions').insert([{
      assigned_group, scenario, device: navigator.platform, locale: navigator.language, user_agent: navigator.userAgent
    }]).select('session_id').single();
    if(error){ q('#status').textContent='å»ºç«‹é€£ç·šå¤±æ•—:'+error.message; return null; }
    SESSION_ID=data.session_id;
    q('#status').textContent='å·²é–‹å§‹,åˆ†çµ„:'+assigned_group;
    return SESSION_ID;
  }
  async function logEvent(step,name,props={},price=null,inventory=null){
    if(!SESSION_ID) return;
    await supabase.from('events').insert([{ session_id: SESSION_ID, step, name, price_shown: price, inventory_shown: inventory, props }]);
  }
  async function logSurvey(step,qid,ans=null,txt=null){
    if(!SESSION_ID) return;
    await supabase.from('surveys').insert([{ session_id: SESSION_ID, step, qid, answer_numeric: ans, answer_text: txt }]);
  }

  /* ====== åŒ¯å‡º CSVï¼ˆåŠ ä¸Š UTF-8 BOM é¿å…äº‚ç¢¼ï¼‰====== */
  function toCSV(rows){
    if(!rows || !rows.length) return "";
    const cols = Array.from(new Set(rows.flatMap(r=>Object.keys(r))));
    const esc = (v) => {
      if (v===null||v===undefined) return "";
      const s = typeof v === "object" ? JSON.stringify(v) : String(v);
      return '"' + s.replace(/"/g,'""') + '"';
    };
    const header = cols.map(esc).join(",");
    const body = rows.map(r => cols.map(c => esc(r[c])).join(",")).join("\n");
    return header + "\n" + body;
  }
  function downloadCSV(filename, content){
    // åŠ ä¸Š UTF-8 BOM è®“ Excel æ­£ç¢ºè­˜åˆ¥ä¸­æ–‡
    const BOM = "\uFEFF";
    const blob = new Blob([BOM + content], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }
  async function fetchAll(table){
    const pageSize = 1000;
    let from = 0, to = pageSize-1, all = [];
    while(true){
      const { data, error } = await supabase.from(table).select("*").range(from, to);
      if(error){ throw new Error(table + " è®€å–å¤±æ•—:" + error.message); }
      if(!data || data.length===0) break;
      all = all.concat(data);
      if(data.length < pageSize) break;
      from += pageSize; to += pageSize;
    }
    return all;
  }
  async function exportAll(){
    const tables = ["sessions","demographics","events","surveys","orders"];
    let successCount = 0;
    for (const t of tables){
      try{ 
        const rows = await fetchAll(t); 
        downloadCSV(t + ".csv", toCSV(rows)); 
        successCount++;
      }
      catch(e){ 
        alert("åŒ¯å‡º " + t + " å¤±æ•—:" + e.message); 
      }
    }
    if(successCount === 5) {
      alert("âœ… æˆåŠŸåŒ¯å‡º 5 å€‹è¡¨æ ¼ï¼\n\nå·²ä¸‹è¼‰ï¼š\nâ€¢ sessions.csv\nâ€¢ demographics.csv\nâ€¢ events.csv\nâ€¢ surveys.csv\nâ€¢ orders.csv");
    }
  }
  
  // ç¶å®šå…©å€‹åŒ¯å‡ºæŒ‰éˆ•ï¼ˆé ‚éƒ¨å’ŒT0é é¢ï¼‰
  q("#btn_export").addEventListener("click", exportAll);
  
  // T0 é é¢çš„ç®¡ç†å“¡æŒ‰éˆ•ç¨å¾Œç¶å®šï¼ˆå› ç‚ºå®ƒä¸€é–‹å§‹æ˜¯éš±è—çš„ï¼‰
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.querySelector("#btn_export_admin");
    if(btn) btn.addEventListener("click", exportAll);
  });

  /* ====== ç®¡ç†å“¡å¯†ç¢¼é©—è­‰ ====== */
  window.checkAdminPassword = function() {
    const password = q('#admin-password').value;
    // ç®¡ç†å“¡å¯†ç¢¼
    const ADMIN_PASSWORD = 'admin2025';
    
    if(password === ADMIN_PASSWORD) {
      // é¡¯ç¤ºé ‚éƒ¨åŒ¯å‡ºæŒ‰éˆ•
      q('#btn_export').classList.remove('hidden');
      // é¡¯ç¤º T0 é é¢çš„ç®¡ç†å“¡é¢æ¿
      const adminPanel = q('#admin-panel');
      if(adminPanel) adminPanel.classList.remove('hidden');
      // éš±è—ç™»å…¥æ¡†
      q('#admin-login').classList.add('hidden');
      alert('âœ… ç®¡ç†å“¡æ¬Šé™å·²å•Ÿç”¨ï¼\n\næ‚¨ç¾åœ¨å¯ä»¥ï¼š\nâ€¢ åœ¨é é¢é ‚éƒ¨çœ‹åˆ°ã€ŒåŒ¯å‡ºè³‡æ–™ã€æŒ‰éˆ•\nâ€¢ åœ¨ T0 é é¢çœ‹åˆ°ç¶ è‰²ç®¡ç†å“¡é¢æ¿\nâ€¢ ä¸€éµä¸‹è¼‰å…¨éƒ¨ 5 å€‹è¡¨æ ¼');
    } else {
      alert('âŒ å¯†ç¢¼éŒ¯èª¤ï¼æ­£ç¢ºå¯†ç¢¼æ˜¯ï¼šadmin2025');
      q('#admin-password').value = '';
    }
  }

  // é€£çºŒé»æ“Šæ¨™é¡Œ 3 æ¬¡é¡¯ç¤ºç®¡ç†å“¡ç™»å…¥æ¡†
  let clickCount = 0;
  let clickTimer = null;
  document.querySelector('h1').addEventListener('click', () => {
    clickCount++;
    if(clickCount === 1) {
      clickTimer = setTimeout(() => { clickCount = 0; }, 2000);
    }
    if(clickCount === 3) {
      clearTimeout(clickTimer);
      clickCount = 0;
      q('#admin-login').classList.toggle('hidden');
    }
  });

  /* ====== T0 é€å‡º ====== */
  q('#t0_next').addEventListener('click', async ()=>{
    const gender = q('#t0_gender').value;
    const age_band = q('#t0_age').value;
    let occupationSel = q('#t0_job_select').value;
    const occupationOther = q('#t0_job_other').value.trim();
    if (occupationSel === "other") occupationSel = occupationOther || "å…¶ä»–";
    const income_band = q('#t0_income').value;
    const education = q('#t0_edu').value;

    if(!gender || !age_band){ alert('è«‹è‡³å°‘å¡«å¯«ã€Œæ€§åˆ¥ã€èˆ‡ã€Œå¹´é½¡å€é–“ã€ã€‚'); return; }
    try{
      const { error } = await supabase.from('demographics').insert([{ session_id: SESSION_ID, gender, age_band, occupation: occupationSel, income_band, education }]);
      if(error) throw error;
      await logEvent('T0','demographics_filled',{gender,age_band,income_band,education});
      hide('T0'); 
      insertHotelInfo('hotel-info-t1');
      q('#price_t1').textContent = EXPERIMENT_CONFIG.prices.T1.toLocaleString();
      q('#hotel-info-t1 #current-price').textContent = EXPERIMENT_CONFIG.prices.T1.toLocaleString();
      show('T1');
    }catch(e){ alert('é€å‡ºå¤±æ•—:'+e.message); }
  });

  /* ====== T1 â†’ T2 ====== */
  q('#t1_next').addEventListener('click', async ()=>{
  const desire=getRadio('t1_intent_desire'); 
  const action=getRadio('t1_intent_action');
  const attention=getRadio('attention_check');
  if(desire==null||action==null||attention==null){ alert('è«‹å®Œæˆå…¨éƒ¨é¡Œç›®å–”'); return; }
  await logSurvey('T1','t1_intent_desire',desire,null);
  await logSurvey('T1','t1_intent_action',action,null);
  await logSurvey('T1','attention_check',attention,null);
    await logEvent('T2','price_change_exposed',{
      old_price: EXPERIMENT_CONFIG.prices.T1,
      new_price: EXPERIMENT_CONFIG.prices.T2,
      change_type:'up',
      delta_pct: EXPERIMENT_CONFIG.priceChange.percentage
    }, EXPERIMENT_CONFIG.prices.T2, EXPERIMENT_CONFIG.inventory.T2);
    hide('T1'); 
    insertHotelInfo('hotel-info-t2');
    q('#hotel-info-t2 #current-price').textContent = EXPERIMENT_CONFIG.prices.T2.toLocaleString();
    q('#t2_old_price').textContent = EXPERIMENT_CONFIG.prices.T1.toLocaleString();
    q('#price_t2').textContent = EXPERIMENT_CONFIG.prices.T2.toLocaleString();
    q('#t2_pct').textContent = (EXPERIMENT_CONFIG.priceChange.percentage * 100).toFixed(0);
    show('T2');
  });

  /* ====== T2 â†’ T3 ====== */
  q('#t2_next').addEventListener('click', async ()=>{
    const locus=getRadio('t2_locus'); const ctrl=getRadio('t2_control'); const upset=getRadio('t2_upset');
    if(locus==null||ctrl==null||upset==null){ alert('è«‹å®Œæˆä¸‰é¡Œå–”'); return; }
    await logSurvey('T2','t2_attrib_locus',locus,null);
    await logSurvey('T2','t2_attrib_control',ctrl,null);
    await logSurvey('T2','t2_emotion_upset',upset,null);
    await logEvent('T3','transparency_shown',{reason_type:'demand_up',detail_level:assigned_group==='C_high'?'high':(assigned_group==='B_mid'?'mid':'low')});
    hide('T2'); 
    insertHotelInfo('hotel-info-t3');
    q('#hotel-info-t3 #current-price').textContent = EXPERIMENT_CONFIG.prices.T2.toLocaleString();
    q('#transparency_block').textContent = TRANSP[assigned_group];
    show('T3');
  });

/* ====== T3 â†’ T3_check ====== */
q('#t3_next').addEventListener('click', async ()=>{
  const fair=getRadio('t3_fair'); 
  const intent=getRadio('t3_intent');
  if(fair==null||intent==null){ alert('è«‹å®Œæˆå…©é¡Œå–”'); return; }
  await logSurvey('T3','t3_fairness',fair,null);
  await logSurvey('T3','t3_intent',intent,null);
  hide('T3'); 
  show('T3_check');
});

/* ====== T3_check (æ“å¼„æª¢æ ¸) â†’ T4 ====== */
q('#t3_check_next').addEventListener('click', async ()=>{
  const understand=getRadio('check_understand');
  const clarity=getRadio('check_clarity');
  if(understand==null||clarity==null){ alert('è«‹å®Œæˆå…©é¡Œå–”'); return; }
  
  const btn = q('#t3_check_next');
  btn.disabled = true;
  btn.textContent = 'â³ è™•ç†ä¸­...';
  
  try {
    await logSurvey('T3','check_understand',understand,null);
    await logSurvey('T3','check_clarity',clarity,null);
    
    hide('T3_check');
    insertHotelInfo('hotel-info-t4');
    q('#hotel-info-t4 #current-price').textContent = EXPERIMENT_CONFIG.prices.T2.toLocaleString();
    show('T4');
  } catch(e) {
    console.error('T3_check éŒ¯èª¤:', e);
    alert('âš ï¸ è³‡æ–™ä¿å­˜å¯èƒ½å¤±æ•—ï¼Œä½†æˆ‘å€‘æœƒç¹¼çºŒé€²è¡Œã€‚');
    
    hide('T3_check');
    insertHotelInfo('hotel-info-t4');
    q('#hotel-info-t4 #current-price').textContent = EXPERIMENT_CONFIG.prices.T2.toLocaleString();
    show('T4');
  } finally {
    btn.disabled = false;
    btn.textContent = 'é€²å…¥æœ€å¾Œæ±ºå®š â†’';
  }
});

/* ====== T4(ä¸‹å–® / æ”¾æ£„) ====== */
// é¸é …å¡ç‰‡é»æ“Šæ•ˆæœ
document.addEventListener('click', (e) => {
  const option = e.target.closest('.slider-option');
  if(option) {
    document.querySelectorAll('.slider-option').forEach(opt => {
      opt.style.borderColor = '#e5e7eb';
      opt.style.background = '#fff';
    });
    option.style.borderColor = '#059669';
    option.style.background = '#dcfce7';
    option.querySelector('input').checked = true;
  }
});




  function sliderLabel(val){
    if(val==0) return "å‰©é¤˜æˆ¿æ•¸";
    if(val==100) return "é€æ˜èªªæ˜";
    return "å…¶ä»–é£¯åº—åƒ¹æ ¼";
  }
  async function submitT4(decision){
    const fair=getRadio('t4_fair'); const intent=getRadio('t4_intent');
    if(fair==null||intent==null){ alert('è«‹å…ˆå®Œæˆå…©é¡Œ'); return; }
    const reasonRadio = document.querySelector('input[name="t4_reason"]:checked');
    const sliderVal = reasonRadio ? Number(reasonRadio.value) : 50;
    const reasonText = sliderLabel(sliderVal);

    await logSurvey('T4','t4_overall_fairness',fair,null);
    await logSurvey('T4','t4_final_intent',intent,null);
    await logSurvey('T4','t4_reason_slider',sliderVal,reasonText);

    try{
      await supabase.from('orders').insert([{ 
        session_id: SESSION_ID, 
        price_paid: decision==="success" ? EXPERIMENT_CONFIG.prices.T2 : null, 
        status: decision 
      }]);
    }catch(e){}
    await logEvent('T4', decision==="success" ? 'complete_checkout':'abandon_checkout',{reason:reasonText, slider:sliderVal});
    q('#done').classList.remove('hidden');
  }
  q('#btn_checkout').addEventListener('click', ()=>submitT4("success"));
  q('#btn_abandon').addEventListener('click', ()=>submitT4("abandon"));

  /* ====== å•Ÿå‹•:å»ºç«‹ session å¾Œé¡¯ç¤º T0 ====== */
  const ok = await startSession();
  await logEvent('T1','view_item',{
    item_id:'RM101',
    competitor_price: EXPERIMENT_CONFIG.competitor.price
  }, EXPERIMENT_CONFIG.prices.T1, EXPERIMENT_CONFIG.inventory.T1);
  show('T0');
</script>
</body>
</html>
